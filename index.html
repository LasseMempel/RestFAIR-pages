<!DOCTYPE html>
<html>
  <head>
    <title>CSV Hierarchy Visualizer</title>
    <!-- <script src="https://cdn.jsdelivr.net/npm/d3@7"></script> -->
    <script src = "d3.v7.js"></script>
  </head>
  <body>
    <h1>CSV Hierarchy Visualizer</h1>
    <label for="httpInput"> URL eingeben: </label>
    <input type="text" id="httpInput" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQCho2k88nLWrNSXj4Mgj_MwER5GQ9zbZ0OsO3X_QPa9s-3UkoeLLQHuNHoFMKqCFjWMMprKVHMZzOj/pub?gid=0&single=true&output=tsv" style="width: 1200px;">
    <br>
    <button onclick = readSheet(0) id="sheetButton" > Sheet visualisieren </button>
    <br>
    <br>
    <input type ="file" id = "fileInput" accept = ".csv">
    <br>
    <button onclick = readSheet(1) id = "fileButton" > Datei visualisieren </button>
    <br>
    <div id="output">
      <p id="outputText"> </p>
      <svg id="outputSVG"> </svg>
      <svg width="400px" height="400px">
        <g transform="translate(5, 50)">
            <g class="links"></g>
            <g class="nodes"></g>
        </g>
      </svg>
    </div>
    <script>
      async function readSheet(method) {
        if (method == 0) {
          let tsvData = await readSheetFromUrl();
          
        } else {
          let tsvData = readSheetFromFile();
        }
        //const cleanedTsvData = cleanTableData(tsvData);
        document.getElementById("sheetButton").innerHTML = tsvData
        document.getElementById("fileButton").innerHTML = tsvData

        const data = {
          "name": "Asia",
          "children": [
              {
                  "name": "Vietnam",
                  "children": [
                      {
                          "name": "Saigon"
                      }
                  ]
                  
              },
              {
                  "name": "India",
                  "children": [
                      {
                          "name": "Mumbai"
                      }
                  ]
                  
              }
          ]
        }

        const table = `identifier,concept,parent
          B51DAF,Ding,top
          A18D95,Mensch,B51DAF
          CD5C3F,Frau,A18D95
          F5G576,Mann,A18D95
          C4BCF8,Kind,A18D95
          B5DD1A,Junge,C4BCF8
          CD3341,Mädchen,C4BCF8
          A11ACA,Essen,B51DAF
          GB6DF3,Gemüse,A11ACA
          C364G1,Obst,A11ACA`;

        try {
          document.getElementById("outputText").innerHTML = JSON.stringify(tsvData);
          createTree(data);
        } catch (error) {
            document.getElementById("outputText").innerHTML = method;
        }
      }

      async function readSheetFromUrl() {
        const target = document.getElementById("httpInput").value;
        let data = await d3.tsv(target)
        return data;
      } 

      function readSheetFromFile() {
        const file = document.getElementById("fileInput").files[0];
        let data = d3.csv(file)
        return data;
      }

      function cleanTableData(data) {
        // iterate over all rows and remove all columns from array, where prefLabel is empty
        const cleanedData = data.filter(row => row.prefLabel !== "");
        //remove all "\r" from text
        //const cleanedText = text.replace(/\r/g, "");
        return cleanedData;
      }

      function createTree(data) {
        var treeLayout = d3.tree().size([400, 200]);
        var root = d3.hierarchy(data); //stratifiedData
        treeLayout(root)
        d3.select("svg g.nodes") 
          .selectAll("circle.node")  
          .data(root.descendants())
          .join("circle")
          .classed("node", true)
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; })
          .attr("r", 10)

        d3.select("svg g.links") 
          .selectAll("line.link")
          .data(root.links())
          .join("line")
          .classed("link", true)
          .style("stroke", "black")
          .attr('x1', function(d) {return d.source.x;})
          .attr('y1', function(d) {return d.source.y;})
          .attr('x2', function(d) {return d.target.x;})
          .attr('y2', function(d) {return d.target.y;});

        d3.select("svg g.nodes")
          .selectAll("text.label")
          .data(root.descendants())
          .join("text")
          .classed("label", true)
          .attr("x", function(d) { return d.x + 15;})
          .attr("y", function(d) { return d.y + 10;})
          .text(d => {
              return d.data.name;
          });
      }
    </script>
  </body>
</html>
