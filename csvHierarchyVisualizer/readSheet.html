<!DOCTYPE html>
<html>
  <head>
    <title>CSV Hierarchy Visualizer</title>
    <!-- <script src="https://d3js.org/d3.v7.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6"></script>
  </head>
  <body>
    <h1>CSV Hierarchy Visualizer</h1>
    <p>Accessing Google sheet table</p>
    <button onclick = readSheet() > Read Sheet </button>
    <div id="output">
      <p id="outputText"> </p>
      <svg id="outputSVG"> </svg>
      <svg width="400px" height="400px">
        <g transform="translate(5, 50)">
            <g class="links"></g>
            <g class="nodes"></g>
        </g>
      </svg>
    </div>
    <script>
      async function readSheet() {
        /*
        https://docs.google.com/spreadsheets/d/e/2PACX-1vRUwEkMkH3Tsllx32stLHYmmLubG8gmkGYgxPrlqQo4Hz939ajwvKJawDxXRzKwQ_h5wvMP4TblUdC4/pub?output=tsv"
        const text = await getText(target);
        //remove all "\r" from text
        const cleanedText = text.replace(/\r/g, "");
        const tableObject = d3.csv(target);
        */
        const tableObject = [{id: 1, parent: null, title: 'Home Office'},
          {id: 2, parent: 1, title: 'Regional Office 2'},
          {id: 3, parent: 1, title: 'Regional Office 1'},
          {id: 4, parent: 3, title: 'Branch 1'},
          {id: 5, parent: 3, title: 'Branch 2'},
          {id: 6, parent: 2, title: 'Branch 3'},
          {id: 7, parent: 2, title: 'Branch 4'}
        ];

        var data = {
          "name": "Asia",
          "children": [
              {
                  "name": "Vietnam",
                  "children": [
                      {
                          "name": "Saigon"
                      }
                  ]
                  
              },
              {
                  "name": "India",
                  "children": [
                      {
                          "name": "Mumbai"
                      }
                  ]
                  
              }
          ]
      }
        try {
          /*
          const stratifiedData = d3.stratify()
          .id((d) => d.name)
          .parentId((d) => d.parent)
          (tableObject);
          */

          //data = parentToChildren(tableObject);
          //document.getElementById("outputText").innerHTML = JSON.stringify(data);
          createTree(data);
        } catch (error) {
            document.getElementById("outputText").innerHTML = error;
        }
      }

      function createTree(data) {
        var treeLayout = d3.tree().size([400, 200]);
        var root = d3.hierarchy(data); //stratifiedData
        treeLayout(root)
        d3.select("svg g.nodes") 
          .selectAll("circle.node")  
          .data(root.descendants())
          .join("circle")
          .classed("node", true)
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; })
          .attr("r", 10)

        d3.select("svg g.links") 
          .selectAll("line.link")
          .data(root.links())
          .join("line")
          .classed("link", true)
          .style("stroke", "black")
          .attr('x1', function(d) {return d.source.x;})
          .attr('y1', function(d) {return d.source.y;})
          .attr('x2', function(d) {return d.target.x;})
          .attr('y2', function(d) {return d.target.y;});

          d3.select("svg g.nodes")
            .selectAll("text.label")
            .data(root.descendants())
            .join("text")
            .classed("label", true)
            .attr("x", function(d) { return d.x + 15;})
            .attr("y", function(d) { return d.y + 10;})
            .text(d => {
                return d.data.name;
            });
      }

      function parentToChildren(array) {
        let tree = [], arrayDictionary = {};
        array.forEach((cat) => {
        arrayDictionary[cat.id] = cat;
        arrayDictionary[cat.id]["children"] = [];
        });
        // for each entry in the dictionary
        for (var entry in arrayDictionary) {

          // get all the data for this entry in the dictionary
          const mappedElem = arrayDictionary[entry];

          // if the element has a parent, add it
          if (
            mappedElem.parentid && // the dictionary has a parent
            arrayDictionary[mappedElem["parent"]] // and that parent exists
            ) {

            arrayDictionary[mappedElem["parent"]]["children"].push(mappedElem);
          }
          // else is at the root level (parentid = null or 0)
          else {
            tree.push(mappedElem);
          }
        }
        return tree;
      }

      /*
      async function getText(url) {
          try {
          const proxyUrl = "https://corsproxy.io/?";
          const response = await fetch(proxyUrl + encodeURIComponent(url));
          const data = await response.text();
          return data;
          } catch (error) {
            return error;
          }
        }
      */

      /*
      function createTableObject(text) {
        const rows = text.split("\n");
        tableObject = {};
        const attributes = rows[0].split("\t");
        for (let i = 1; i < rows.length; i++) {
            const columns = rows[i].split("\t");
            if (columns[1].length > 0) {
              tableObject[columns[0]] = {}
              for (let j = 1; j < columns.length; j++) {
                tableObject[columns[0]][attributes[j]] = columns[j];
              }
            }
          }
        return tableObject;
      }
      */

    </script>
  </body>
</html>